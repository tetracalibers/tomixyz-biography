---
title: "css # CSSのSyntax"
date: "2024-06-13"
description: TODO
private: true
series: ja/learn-browsers-rendering
tags:
  - Browser
  - CSS
---

CSSパーサーの実装に取り掛かる前に、CSSという言語の仕様を見つめ直します。

## CSSのトークン

[CSS Syntax Module Level 3](https://www.w3.org/TR/css-syntax-3/)の[Token Railroad Diagrams](https://www.w3.org/TR/css-syntax-3/#token-diagrams)で概説されているトークンのうち、特にCSS特有のものを整理します。

### comment

`/* これはコメントです */`のような、CSSのコメントです。
「`/*`」で始まり、任意の内容が続き、「`*/`」で終了するという構造になっています。

1. **開始記号**：コメントは「`/*`」から始まります。
2. **コメント内容**：
   - 「`/*`」の後には、アスタリスク（`*`）とスラッシュ（`/`）の組み合わせ以外の任意の文字が続きます。この部分にはコメント内容が入ります。
3. **終了記号**：コメントは「`*/`」で終了します。

### escape

バックスラッシュ（`\`）から始まるエスケープシーケンスです。

1. **開始記号**：バックスラッシュ（`\`）から始まります。
2. **条件分岐**：
   - **一つ目の分岐**：改行（newline）や16進数の数字（hex digit）以外の文字。
   - **二つ目の分岐**：16進数の数字。この分岐は1回から6回まで繰り返すことができます。
3. **空白文字の処理**：16進数の数字の後には、空白文字が続く場合があります。

例えば、`\0041`では、バックスラッシュに続いて「0041」という4桁の16進数が続きます。
空白文字がその後に来ることもありますが、必須ではありません。

### ident-token

ここでのidentはidentifierの略であり、CSSの識別子を表すトークンです。

識別子は特定の文字やシーケンスで始まり、その後も特定の文字やシーケンスが続くという構造になっています。

1. **開始記号**：識別子は、以下のいずれかで始まります。

   - ハイフン（`-`）
   - 2つのハイフン（`--`）
   - 英字（a-z, A-Z）、アンダースコア（\_）、非ASCII文字
   - エスケープシーケンス

2. **二つ目の要素**：続く要素は以下のいずれかです。
   - 英字（a-z, A-Z）、数字（0-9）、アンダースコア（\_）、ハイフン（-）、非ASCII文字
   - エスケープシーケンス

例えば：`my-identifier`、`--my-identifier`、`_underscore`、`ident123`

### function-token

CSSの関数呼び出しを表すトークンです。

関数呼び出しは識別子トークンで始まり、開きカッコで続くという構造になっています。

1. **識別子トークン（`<ident-token>`）**：

   - 関数呼び出しは識別子トークンで始まります。

2. **開きカッコ（`(`）**：
   - 識別子トークンの後には、必ず開きカッコ「`(`」が続きます。

例えば：`rgb(`、`calc(`、`url(`

### at-keyword-token

CSSの[アットルール](https://developer.mozilla.org/ja/docs/Web/CSS/At-rule)を表します。

アットマーク（`@`）で始まり、その後に識別子トークンが続くという構造です。

1. **開始記号**：アットマーク（`@`）から始まります。
2. **識別子トークン（`<ident-token>`）**：
   - アットマークの後に続くのは識別子トークンです。

例えば：`@media`、`@import`、`@font-face`

### hash-token

CSSのIDセレクターなどでみられるトークンです。

ハッシュ記号（`#`）で始まり、その後に識別子トークンが続くという構造です。

1. **開始記号**：IDセレクターはハッシュ記号（`#`）から始まります。
2. **識別子トークン（`<ident-token>`）**：
   - ハッシュ記号の後には、次のいずれかの文字が続きます：
     - 英字（a-z, A-Z）
     - 数字（0-9）
     - アンダースコア（\_）
     - ハイフン（-）
     - 非ASCII文字
     - エスケープシーケンス

例えば：`#myID`、`#content-123`、`#_header`

### string-token

CSSの文字列を表すトークンです。

文字列は引用符で始まり、その中に特定の文字やシーケンスが含まれ、最後に同じ引用符で終了するという構造になっています。

1. **開始記号**：

   - 文字列は二重引用符（`"`）または単一引用符（`'`）で始まります。

2. **文字列の内容**：

   - 二重引用符（`"`）の場合、次のいずれかの文字が続きます：

     - 二重引用符（`"`）や改行（newline）以外の任意の文字
     - エスケープシーケンス（バックスラッシュ `\` に続く文字）
     - 改行（newline）

   - 単一引用符（`'`）の場合も同様で、次のいずれかの文字が続きます：
     - 単一引用符（`'`）や改行（newline）以外の任意の文字
     - エスケープシーケンス（バックスラッシュ `\` に続く文字）
     - 改行（newline）

3. **終了記号**：
   - 文字列は、開始記号と同じ引用符（`"` または `'`）で終了します。

例えば：

- `"これは文字列です"`
- `'これは文字列です'`
- `"エスケープシーケンス: \""`
- `'エスケープシーケンス: \''`、

### url-token

CSSの`url()`関数を表すトークンです。

`url`という識別子トークンで始まり、開きカッコで続き、その中にURLの内容が含まれ、最後に閉じカッコで終わるという構造になっています。

1. **識別子トークン（`<ident-token "url">`）**：

   - `url` という識別子トークンから始まります。

2. **開きカッコ（`(`）**：

   - `url` の後には開きカッコ `(` が続きます。

3. **ホワイトスペース（`ws*`）**：

   - 開きカッコの後には任意の数のホワイトスペースが続きます（0個以上）。

4. **URLの内容**：

   - URLの内容には次のいずれかが含まれます：
     - 二重引用符 `"`、単一引用符 `'`、バックスラッシュ `\`、ホワイトスペース（`ws`）、非印字可能文字以外の任意の文字
     - エスケープシーケンス

5. **ホワイトスペース（`ws*`）**：

   - URLの内容の後には再び任意の数のホワイトスペースが続きます（0個以上）。

6. **閉じカッコ（`)`）**：
   - 最後に閉じカッコ `)` で終わります。

例えば：

- `url(http://example.com)`
- `url("http://example.com")`
- `url('http://example.com')`
- `url(https://example.com/path/to/resource)`

### number-token

CSSの数値を表すトークンです。

数値はオプションの符号で始まり、整数部、小数部、そしてオプションの指数部で構成されるという構造になっています。

1. **符号（オプション）**：

   - 数値はオプションでプラス（`+`）またはマイナス（`-`）の符号で始まります。

2. **数値の構成**：

   - 数値は以下のいずれかの形式で構成されます：
     - 一つ以上の数字（digit）
     - 一つ以上の数字に続くドット（`.`）と数字
     - ドット（`.`）に続く一つ以上の数字

3. **指数部（オプション）**：
   - 数値の後にオプションで指数部が続く場合があります。指数部は以下のように構成されます：
     - `e` または `E` で始まり、その後にオプションでプラス（`+`）またはマイナス（`-`）の符号が続き、一つ以上の数字が続きます。

例えば：`42`、`-42`、`+42`、`3.14`、`-3.14`、`.5`、`-0.5`、`2e10`、`-2E-10`

### dimension-token

CSSで使用される単位付きの数値などでみられるトークンです。

1. **数値トークン（`<number-token>`）**：

   - 数値トークンは、先ほど説明したようなCSSの数値です。これはオプションの符号、整数部、小数部、オプションの指数部で構成されます。

2. **識別子トークン（`<ident-token>`）**：
   - 識別子トークンは、CSSの識別子であり、英字（a-z, A-Z）、アンダースコア（\_）、ハイフン（-）、非ASCII文字、エスケープシーケンスなどで構成されます。

例えば：`10px`、`1em`、`2.5rem`、`-3deg`

### percentage-token

CSSのパーセンテージ値を表すトークンです。

1. **数値トークン（`<number-token>`）**：

   - 数値トークンは、先ほど説明したようなCSSの数値です。これはオプションの符号、整数部、小数部、オプションの指数部で構成されます。

2. **パーセンテージ記号（`%`）**：
   - 数値トークンの後には、パーセンテージ記号（`%`）が続きます。

例えば：`50%`、`100%`、`-20%`、`0.5%`

## スタイルシートの構成要素

### Component Value

成分値は、プリザーブドトークン、シンプルブロック、関数ブロックのいずれかで構成されます。

1. **プリザーブドトークン（`Preserved token`）**：

   - トークナイザーによって生成される、`<function-token>`、`<{-token>`、`<(-token>`、`<[-token>`以外の任意のトークン

2. **シンプルブロック（`Simple block`）**：

   - シンプルブロックは、前の図で示されたように、波括弧 `{}`, 丸括弧 `()`, 角括弧 `[]` で囲まれたブロックです。

3. **関数ブロック（`Function block`）**：
   - 関数ブロックは、関数名と丸括弧で構成されるブロックです。関数の中に引数や式が含まれます。

### Simple block

単純ブロックは、波括弧、丸括弧、角括弧で囲まれたブロックの中にコンポーネント値が含まれる構造です。

1. **波括弧ブロック（`{}` block）**：

   - 開き波括弧 `{` で始まり、閉じ波括弧 `}` で終わるブロックです。
   - 中にはコンポーネント値（`Component value`）が含まれます。

2. **丸括弧ブロック（`() block）**：

   - 開き丸括弧 `(` で始まり、閉じ丸括弧 `)` で終わるブロックです。
   - 中にはコンポーネント値（`Component value`）が含まれます。

3. **角括弧ブロック（`[] block）**：
   - 開き角括弧 `[` で始まり、閉じ角括弧 `]` で終わるブロックです。
   - 中にはコンポーネント値（`Component value`）が含まれます。

例えば：`body { background-color: white; }`、`calc(100% - 50px)`、`input[type="text"]`

### Function Block

関数は、関数トークンで始まり、コンポーネント値が続き、最後に閉じカッコで終わるという構造です。

1. **関数トークン（`<function-token>`）**：

   - 関数トークンは関数名と開きカッコ `(` から構成されます。例えば、`calc(` や `rgb(` などです。

2. **コンポーネント値（`Component value`）**：

   - 関数トークンの後にはコンポーネント値が続きます。コンポーネント値は、関数の引数や内容を示します。

3. **閉じカッコ（`)`）**：
   - コンポーネント値の後には閉じカッコ `)` が続きます。

例えば：`calc(100% - 50px)`、`rgb(255, 0, 0)`、`url('image.jpg')`

### !important

`!important`ディレクティブは、感嘆符 `!` で始まり、その後に任意の数のホワイトスペース、次に "important" という識別子トークンが続き、さらに任意の数のホワイトスペースが続くという構造です。

1. **感嘆符（`!`）**：

   - `!important` ディレクティブは感嘆符 `!` から始まります。

2. **ホワイトスペース（`ws*`）**：

   - 感嘆符の後には、任意の数のホワイトスペース（空白文字）が続きます（0個以上）。

3. **識別子トークン（`<ident-token "important">`）**：

   - 続いて、識別子トークン "important" が来ます。

4. **ホワイトスペース（`ws*`）**：
   - "important" の後には、再び任意の数のホワイトスペース（空白文字）が続きます（0個以上）。

### Declaration

宣言はプロパティ名を示す識別子トークンで始まり、その後にコロン、続いてプロパティの値を示すコンポーネント値が続き、オプションで `!important` が付加されるという構造です。

1. **識別子トークン（`<ident-token>`）**：

   - 宣言はプロパティ名を示す識別子トークンで始まります。

2. **ホワイトスペース（`ws*`）**：

   - 識別子トークンの後には任意の数のホワイトスペースが続きます（0個以上）。

3. **コロン（`:`）**：

   - ホワイトスペースの後にコロン `:` が続きます。

4. **コンポーネント値（`Component value`）**：

   - コロンの後にはコンポーネント値が続きます。コンポーネント値は、プロパティに割り当てられる具体的な値を示します。

5. **`!important`（オプション）**：
   - コンポーネント値の後にはオプションで `!important` が続くことがあります。これは、重要度が高い宣言を示します。

例えば： `background-color: blue !important;`、`margin: 10px;`

### Declaration list

宣言リストはホワイトスペース、宣言、セミコロン、さらに宣言リストが続くという構造です。宣言の代わりにアットルールが来ることもあります。

1. **ホワイトスペース（`ws*`）**：

   - 最初に任意の数のホワイトスペースが含まれます（0個以上）。

2. **宣言（`Declaration`）**：

   - 次に、CSSの宣言が続きます。宣言はプロパティとその値のペアで構成されます。

3. **セミコロン（`;`）**：

   - 宣言の後にはセミコロン（`;`）が続きます。

4. **宣言リスト（`Declaration list`）**：

   - セミコロンの後には再び宣言リストが続きます。これは、さらに宣言を追加できることを意味します。

5. **アットルール（`At-rule`）**：

   - また、宣言の代わりにアットルール（`@`で始まるCSSルール）が来る場合もあります。

6. **宣言リスト（`Declaration list`）**：
   - アットルールの後にも宣言リストが続きます。

### Qualified rule

Qualified ruleは、コンポーネント値で始まり、その後にブロック `{}` が続くという構造です。

1. **コンポーネント値（`Component value`）**：

   - ブロック構造の最初にはコンポーネント値が含まれます。コンポーネント値は、ブロック内で使用される具体的な内容や値を示します。

2. **ブロック（`{}` block）**：
   - コンポーネント値の後にはブロック `{}` が続きます。ブロック内には、関連する詳細なルールやスタイルが含まれます。

TODO: 要確認
例えば、以下のようなCSSのブロックを表しています：

```css
@media (min-width: 600px) {
  body {
    background-color: gray;
  }
}
```

この例では、コンポーネント値がメディアクエリの条件「`(min-width: 600px)`」であり、その後に `{}` ブロックが続き、ブロック内に具体的なスタイルが記述されています。

### At-rule

At-ruleはアットマークで始まり、キーワードが続き、詳細な内容を含むコンポーネント値が続き、その後にブロックもしくはセミコロンが続くという構造です。

1. **Atキーワードトークン（`<at-keyword-token>`）**：

   - At-ruleはアットマーク（`@`）で始まり、その後にキーワードが続くトークンです。例えば、`@media` や `@import` などです。

2. **コンポーネント値（`Component value`）**：

   - At-ruleには、続けてコンポーネント値が含まれます。コンポーネント値は、At-ruleの具体的な内容を示します。

3. **ブロック（`{}` block）**：

   - コンポーネント値の後には、ブロック `{}` が続きます。ブロック内には、At-ruleに関連する詳細なルールやスタイルが含まれます。

{/* prettier-ignore */}
3. **セミコロン（`;`）**：

    - ブロックの後には、オプションでセミコロン（`;`）が続くことがあります。

```css title="例：セミコロンで終わる場合のAt-rule"
@import url("styles.css");
```

```css title="例：ブロックで終わる場合のAt-rule"
@media (min-width: 600px) {
  body {
    background-color: gray;
  }
}
```

### Stylesheet

スタイルシートは、以下のいずれかの要素で構成されます。

- **ホワイトスペーストークン（`<whitespace-token>`）**：

  - ホワイトスペーストークンは空白文字（スペース、タブ、改行など）です。

- **Qualified rule**：

  - Qualified ruleは、CSSルールセット（セレクタと宣言ブロックから構成される）を示します。

- **At-rule**：
  - At-ruleは、「@」で始まるCSSルール（例：`@media`、`@import`）です。

つまり、スタイルシートは、次の2種類のルールを並べたものであり、ルールとルールの間には空白文字を置くことが許されます。

- Qualified rule（要素にスタイルを適用する修飾ルール）
- At-rule（CSSの特別な処理ルールや値を定義するルール）

TODO: いい感じの注釈記法を作りたい
※Stylesheetには、CDOトークン（`<!--`）やCDCトークン（`-->`）が含まれる場合もありますが、このプロジェクトでの実装では省略します。
StylesheetからCDOトークンやCDCトークンを除いたものは、厳密にはRule listと呼ばれますが、ここではRule listとStylesheetを同一視しています。

---

## 参考リンク

- [CSS Syntax Module Level 3](https://www.w3.org/TR/css-syntax-3/)
