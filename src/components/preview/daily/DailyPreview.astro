---
import { splitLangSlug } from "$/utils/i18n/collection"
import { buildPageUrlFor } from "$/utils/i18n/slug"
import type { CollectionEntry } from "astro:content"
import remarkParse from "remark-parse"
import remarkMdx from "remark-mdx"
import { unified } from "unified"
import { visit } from "unist-util-visit"

async function extractFirstParagraph(mdxString: string) {
  const tree = unified().use(remarkParse).use(remarkMdx).parse(mdxString)

  let firstParagraphText = ""

  visit(tree, "paragraph", (node) => {
    if (!firstParagraphText) {
      firstParagraphText = node.children.map((child) => child.value || "").join("")
    }
  })

  return firstParagraphText
}

interface Props {
  entry: CollectionEntry<"daily"> & { date: string; year: string; month: string; day: string }
  lang?: string
}

const { entry } = Astro.props

const { slug: date, lang } = splitLangSlug(entry.slug)

const builPageUrl = buildPageUrlFor("daily")
const pageUrl = builPageUrl(date, lang)

const formatDate = (date: string) => {
  return date.replaceAll("-", ".")
}
---

<div class='_timeline-section-inner grid gap-6'>
  <div
    class='_timeline-date relative w-fit bg-purple-200 border border-purple-300 rounded-sm dark:text-theme-secondary py-0.5 px-[15px]'
  >
    {formatDate(date)}
  </div>
  <div class='_row grid gap-8 grid-cols-[repeat(auto-fill,minmax(300px,1fr))]'>
    <div class='_timeline-box flex flex-col justify-between rounded-sm bg-white/10 border border-slate-300 shadow-sm'>
      <div class='_box-title py-[5px] px-[15px]'></div>
      <div class='_box-content flex flex-col gap-2 flex-1 py-[5px] px-[15px]'>
        {extractFirstParagraph(entry.body)}
      </div>
      <div class='_box-footer text-end py-[5px] px-[15px]'>
        <a class='hover:underline text-end' href={pageUrl}>read more...</a>
      </div>
    </div>
  </div>
</div>
