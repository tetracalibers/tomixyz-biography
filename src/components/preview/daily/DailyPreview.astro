---
import { splitLangSlug } from "$/utils/i18n/collection"
import { buildPageUrlFor } from "$/utils/i18n/slug"
import type { CollectionEntry } from "astro:content"
import remarkParse from "remark-parse"
import remarkMdx from "remark-mdx"
import { unified } from "unified"
import { visit } from "unist-util-visit"

async function extractFirstParagraph(mdxString: string) {
  const tree = unified().use(remarkParse).use(remarkMdx).parse(mdxString)

  let firstParagraphText = ""

  visit(tree, "paragraph", (node) => {
    if (!firstParagraphText) {
      firstParagraphText = node.children.map((child) => child.value || "").join("")
    }
  })

  return firstParagraphText
}

interface Props {
  entry: CollectionEntry<"daily">
  lang?: string
}

const { entry } = Astro.props

const { slug: date, lang } = splitLangSlug(entry.slug)

const builPageUrl = buildPageUrlFor("daily")
const pageUrl = builPageUrl(date, lang)

const formatDate = (date: string) => {
  return date.replaceAll("-", ".")
}
---

<div class="flex gap-6">
  <div class="bg-fuchsia-100 max-w-[300px] p-4 grid gap-4">
    <div>
      <h2 class="text-xl font-semibold text-theme-primary dark:text-theme-dark-primary mb-2">
        <a class="hover:underline" href={pageUrl}>{formatDate(date)}</a>
      </h2>
      <div class="text-sm">{extractFirstParagraph(entry.body)}</div>
    </div>
    <a class="hover:underline text-end" href={pageUrl}>read more...</a>
  </div>
</div>
